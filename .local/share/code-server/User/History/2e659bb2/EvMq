# Build frontend
FROM node:18-slim AS frontend-build
WORKDIR /app
COPY frontend/package*.json ./frontend/
RUN npm --prefix frontend install
COPY frontend/ ./frontend/
RUN npm --prefix frontend run build

# Build backend
FROM node:18-slim AS backend-build
WORKDIR /backend
COPY backend/package*.json ./
RUN npm install
COPY backend/ .

# Production image
FROM nginx:alpine
# Copy frontend static files to nginx folder
COPY --from=frontend-build /app/frontend/dist /usr/share/nginx/html
# Copy backend application
COPY --from=backend-build /backend /backend
# Start backend and frontend servers
CMD ["sh", "-c", "node /backend/server.js & nginx -g 'daemon off;'"]